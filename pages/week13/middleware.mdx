import { Callout, Steps } from "nextra-theme-docs";

# Middleware

Middleware is a powerful feature that allows you to run server-side code during the lifecycle of a request. Middleware functions can perform tasks like manipulating the request or response objects, handling cookies, checking authentication status, and more. Most modern web frameworks have some sort of middleware system.

This week we'll learn how to create and use middleware in Next.js, and then we'll use middleware to create a custom authentication system for our application.

## Next.js Middleware

To implement middleware in Next.js, we need to create a file called `middleware.js` in the root of the project.

Here is an example of a middleware function that redirects the user to the login page if they are not authenticated:

```ts
import type { NextRequest } from "next/server";
import { NextResponse } from "next/server";
import { getSession } from "next-auth/client";

export function middleware(request: NextRequest) {
  const session = await getSession({ request });

  if (!session) {
    return NextResponse.redirect(new URL("/login", request.nextUrl));
  }
}
```

Please read through this short page on [middleware in Next.js](https://nextjs.org/docs/app/building-your-application/routing/middleware) or watch the video below.

<iframe
  style={{ width: "100%", aspectRatio: "16/9" }}
  src="https://www.youtube.com/embed/NUHAc1wjL3A?si=LtbI50mvskMIJkBo"
  title="YouTube video player"
  frameBorder="0"
  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
  allowFullScreen="allowFullScreen"
></iframe>

## Auth.js

Auth.js (formerly NextAuth.js) is a library that makes it easy to add authentication to your Next.js application. It supports a wide variety of authentication providers, including email/password, OAuth, and more. It also supports a wide variety of databases, including MongoDB, Postgres, and Prisma ORM.

New documentation can be found here: https://authjs.dev/getting-started/introduction

Old documentation can be found here: https://next-auth.js.org/getting-started/introduction

### Email Authentication

When a user signs up for your application using their email address, you need to send them an email containing a magic link. A magic link is a link that, when clicked, logs the user in. It's a great way to implement passwordless authentication. Auth.js supports magic links out of the box. You can read more about magic links here: https://authjs.dev/getting-started/providers/email-tutorial

Here are the steps outlining how a magic link works in next-auth.js:

<Steps>

### User requests a magic link

The user enters their email address into a form on your application. When they submit the form, a POST request is sent to your Next.js API route (usually /api/auth/send-magic-link) with their email address.

### Application generates a unique token and sends an email

The next-auth.js library creates a unique, one-time-use token associated with the user's email address. It then sends an email to the user containing a magic link. This link includes the token as a query parameter and points to your application (e.g., https://your-app.com/api/auth/callback/magic-link?token=abcd1234).

### User clicks the magic link

The user opens their email and clicks the magic link. This sends a GET request to the callback URL included in the link.

### Application verifies the token and authenticates the user

The next-auth.js library checks the token in the URL against the token stored on the server. If they match, next-auth.js knows the user is genuine. It then creates an authenticated session for the user. The token is invalidated as soon as it's used, ensuring it can't be used again.

### User is redirected to the application

Once the user is authenticated, next-auth.js redirects them to your application (typically the page they were on when they requested the magic link). They will now be logged in and can access authenticated routes and data.

</Steps>

### Next-Auth.js Tutorials

Here are some tutorials that will help you get started with Next-Auth.js:

<iframe
  style={{ width: "100%", aspectRatio: "16/9" }}
  src="https://www.youtube.com/embed/w2h54xz6Ndw?si=8hNonqZsd-NQ2-vD"
  title="YouTube video player"
  frameBorder="0"
  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
  allowFullScreen="allowFullScreen"
></iframe>

<iframe
  style={{ width: "100%", aspectRatio: "16/9" }}
  src="https://www.youtube.com/embed/md65iBX5Gxg?si=dQRnlXYe3Oxt9rhH"
  title="YouTube video player"
  frameBorder="0"
  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
  allowFullScreen="allowFullScreen"
></iframe>
